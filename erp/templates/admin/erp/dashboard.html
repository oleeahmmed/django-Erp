{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}{{ title }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; {% trans 'Dashboard' %}
</div>
{% endblock %}

{% block content %}
<style>
    .dashboard {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .dashboard-header {
        margin-bottom: 24px;
    }
    .dashboard-header h1 {
        font-size: 28px;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }
    .dashboard-header p {
        color: #6b7280;
        margin: 4px 0 0 0;
    }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }
    .stat-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        transition: box-shadow 0.2s;
    }
    .stat-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .stat-card.primary { border-left: 4px solid #3b82f6; }
    .stat-card.success { border-left: 4px solid #10b981; }
    .stat-card.warning { border-left: 4px solid #f59e0b; }
    .stat-card.danger { border-left: 4px solid #ef4444; }
    .stat-card.purple { border-left: 4px solid #8b5cf6; }
    
    .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
    }
    .stat-label {
        font-size: 13px;
        color: #6b7280;
        margin-top: 4px;
    }
    .stat-icon {
        float: right;
        font-size: 32px;
        opacity: 0.3;
    }
    
    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 24px;
    }
    .chart-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
    }
    .chart-card h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 16px 0;
    }
    .chart-container {
        height: 250px;
    }
    
    /* Tables */
    .tables-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
    .table-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
    }
    .table-card h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        padding: 16px 20px;
        margin: 0;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
    }
    .table-card table {
        width: 100%;
        border-collapse: collapse;
    }
    .table-card th, .table-card td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #f3f4f6;
        font-size: 13px;
    }
    .table-card th {
        background: #f9fafb;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        font-size: 11px;
    }
    .table-card tr:hover {
        background: #f9fafb;
    }
    
    .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }
    .status-draft { background: #e5e7eb; color: #374151; }
    .status-confirmed { background: #dbeafe; color: #1e40af; }
    .status-processing { background: #fef3c7; color: #92400e; }
    .status-completed { background: #d1fae5; color: #065f46; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }
    .status-paid { background: #d1fae5; color: #065f46; }
    .status-overdue { background: #fee2e2; color: #991b1b; }
    
    .low-stock { color: #ef4444; font-weight: 600; }
    
    @media (max-width: 1200px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
        .charts-grid { grid-template-columns: 1fr; }
        .tables-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="dashboard">
    <div class="dashboard-header">
        <h1>{{ title }}</h1>
        <p>{{ subtitle }}</p>
    </div>
    
    <!-- Key Metrics -->
    <div class="stats-grid">
        <div class="stat-card primary">
            <span class="stat-icon">üí∞</span>
            <div class="stat-value">‡ß≥{{ total_revenue|floatformat:0 }}</div>
            <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card success">
            <span class="stat-icon">üìà</span>
            <div class="stat-value">‡ß≥{{ monthly_revenue|floatformat:0 }}</div>
            <div class="stat-label">This Month Revenue</div>
        </div>
        <div class="stat-card warning">
            <span class="stat-icon">üìã</span>
            <div class="stat-value">‡ß≥{{ total_receivables|floatformat:0 }}</div>
            <div class="stat-label">Total Receivables</div>
        </div>
        <div class="stat-card danger">
            <span class="stat-icon">üí≥</span>
            <div class="stat-value">‡ß≥{{ total_payables|floatformat:0 }}</div>
            <div class="stat-label">Total Payables</div>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card primary">
            <span class="stat-icon">üë•</span>
            <div class="stat-value">{{ total_customers }}</div>
            <div class="stat-label">Active Customers</div>
        </div>
        <div class="stat-card success">
            <span class="stat-icon">üöö</span>
            <div class="stat-value">{{ total_suppliers }}</div>
            <div class="stat-label">Active Suppliers</div>
        </div>
        <div class="stat-card purple">
            <span class="stat-icon">üì¶</span>
            <div class="stat-value">{{ total_products }}</div>
            <div class="stat-label">Active Products</div>
        </div>
        <div class="stat-card warning">
            <span class="stat-icon">‚ö†Ô∏è</span>
            <div class="stat-value">{{ low_stock_count }}</div>
            <div class="stat-label">Low Stock Items</div>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card primary">
            <span class="stat-icon">üõí</span>
            <div class="stat-value">{{ total_sales_orders }}</div>
            <div class="stat-label">Total Sales Orders ({{ pending_sales_orders }} pending)</div>
        </div>
        <div class="stat-card success">
            <span class="stat-icon">üìÑ</span>
            <div class="stat-value">{{ total_invoices }}</div>
            <div class="stat-label">Total Invoices ({{ unpaid_invoices }} unpaid)</div>
        </div>
        <div class="stat-card warning">
            <span class="stat-icon">üè≠</span>
            <div class="stat-value">{{ total_purchase_orders }}</div>
            <div class="stat-label">Purchase Orders ({{ pending_purchase_orders }} pending)</div>
        </div>
        <div class="stat-card purple">
            <span class="stat-icon">üè¶</span>
            <div class="stat-value">‡ß≥{{ total_bank_balance|floatformat:0 }}</div>
            <div class="stat-label">Bank Balance</div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="charts-grid">
        <div class="chart-card">
            <h3>üìä Weekly Sales Trend</h3>
            <div class="chart-container">
                <canvas id="weeklySalesChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>üìà Sales vs Purchase (6 Months)</h3>
            <div class="chart-container">
                <canvas id="salesVsPurchaseChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>üéØ Order Status Distribution</h3>
            <div class="chart-container">
                <canvas id="orderStatusChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>üì¶ Inventory Status</h3>
            <div class="chart-container">
                <canvas id="inventoryChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Tables -->
    <div class="tables-grid">
        <div class="table-card">
            <h3>üõí Recent Sales Orders</h3>
            <table>
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in recent_sales_orders %}
                    <tr>
                        <td><a href="{% url 'admin:erp_salesorder_change' order.id %}">{{ order.order_number }}</a></td>
                        <td>{{ order.customer.name }}</td>
                        <td>‡ß≥{{ order.total_amount|floatformat:0 }}</td>
                        <td><span class="status-badge status-{{ order.status }}">{{ order.get_status_display }}</span></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" style="text-align: center; color: #9ca3af;">No recent orders</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="table-card">
            <h3>üìÑ Recent Invoices</h3>
            <table>
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in recent_invoices %}
                    <tr>
                        <td><a href="{% url 'admin:erp_invoice_change' invoice.id %}">{{ invoice.invoice_number }}</a></td>
                        <td>{{ invoice.customer.name }}</td>
                        <td>‡ß≥{{ invoice.total_amount|floatformat:0 }}</td>
                        <td><span class="status-badge status-{{ invoice.status }}">{{ invoice.get_status_display }}</span></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" style="text-align: center; color: #9ca3af;">No recent invoices</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="table-card">
            <h3>üè≠ Recent Purchase Orders</h3>
            <table>
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Supplier</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in recent_purchase_orders %}
                    <tr>
                        <td><a href="{% url 'admin:erp_purchaseorder_change' order.id %}">{{ order.order_number }}</a></td>
                        <td>{{ order.supplier.name }}</td>
                        <td>‡ß≥{{ order.total_amount|floatformat:0 }}</td>
                        <td><span class="status-badge status-{{ order.status }}">{{ order.get_status_display }}</span></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" style="text-align: center; color: #9ca3af;">No recent orders</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="table-card">
            <h3>‚ö†Ô∏è Low Stock Products</h3>
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>SKU</th>
                        <th>Stock</th>
                        <th>Min Level</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in low_stock_products %}
                    <tr>
                        <td><a href="{% url 'admin:erp_product_change' product.id %}">{{ product.name }}</a></td>
                        <td>{{ product.sku }}</td>
                        <td class="low-stock">{{ product.current_stock }} {{ product.unit }}</td>
                        <td>{{ product.min_stock_level }} {{ product.unit }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" style="text-align: center; color: #10b981;">‚úì All products in stock</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Weekly Sales Chart
    new Chart(document.getElementById('weeklySalesChart'), {
        type: 'line',
        data: {
            labels: {{ weekly_labels|safe }},
            datasets: [{
                label: 'Sales',
                data: {{ weekly_sales|safe }},
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
    
    // Sales vs Purchase Chart
    new Chart(document.getElementById('salesVsPurchaseChart'), {
        type: 'bar',
        data: {
            labels: {{ sales_vs_purchase_labels|safe }},
            datasets: [
                {
                    label: 'Sales',
                    data: {{ sales_data|safe }},
                    backgroundColor: '#10b981'
                },
                {
                    label: 'Purchase',
                    data: {{ purchase_data|safe }},
                    backgroundColor: '#f59e0b'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // Order Status Chart
    new Chart(document.getElementById('orderStatusChart'), {
        type: 'doughnut',
        data: {
            labels: {{ order_status_labels|safe }},
            datasets: [{
                data: {{ order_status_data|safe }},
                backgroundColor: ['#9ca3af', '#3b82f6', '#f59e0b', '#10b981', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // Inventory Chart
    new Chart(document.getElementById('inventoryChart'), {
        type: 'pie',
        data: {
            labels: {{ inventory_labels|safe }},
            datasets: [{
                data: {{ inventory_data|safe }},
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
</script>
{% endblock %}
