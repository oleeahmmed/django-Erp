{% extends "unfold/layouts/base.html" %}
{% load i18n static unfold %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    <span class="separator">â€º</span>
    <span>{% trans 'Stock Report' %}</span>
</div>
{% endblock %}

{% block content %}
<div class="report-container">
    <div class="space-y-6">
        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-3xl font-bold tracking-tight bg-gradient-to-r from-primary-600 to-primary-400 bg-clip-text text-transparent">
                    {% trans "Stock Report" %}
                </h1>
                <p class="mt-2 text-sm text-muted-foreground">{% trans "View and filter inventory records" %}</p>
            </div>
        </div>

        <!-- Filter Form -->
        <div class="rounded-xl border bg-card text-card-foreground shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4">{% trans "Filters" %}</h3>
            <form method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Category" %}</label>
                    <select name="category" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                        <option value="">{% trans "All Categories" %}</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if filters.category == category.id|stringformat:"s" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Stock Status" %}</label>
                    <select name="stock_status" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                        <option value="">{% trans "All" %}</option>
                        <option value="low" {% if filters.stock_status == "low" %}selected{% endif %}>{% trans "Low Stock" %}</option>
                        <option value="out" {% if filters.stock_status == "out" %}selected{% endif %}>{% trans "Out of Stock" %}</option>
                        <option value="in" {% if filters.stock_status == "in" %}selected{% endif %}>{% trans "In Stock" %}</option>
                    </select>
                </div>
                <div class="flex gap-2 items-end">
                    <button type="submit"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700">
                        {% trans "Apply Filters" %}
                    </button>
                    <a href="{% url 'erp:stock-report' %}"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                        {% trans "Clear" %}
                    </a>
                </div>
            </form>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="rounded-xl border bg-card text-card-foreground shadow-md p-5">
                <p class="text-sm font-medium text-muted-foreground mb-1">{% trans "Total Products" %}</p>
                <p class="text-2xl font-bold">{{ total_products }}</p>
            </div>
            <div class="rounded-xl border bg-card text-card-foreground shadow-md p-5">
                <p class="text-sm font-medium text-muted-foreground mb-1">{% trans "Stock Value" %}</p>
                <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${{ total_stock_value|floatformat:2 }}</p>
            </div>
            <div class="rounded-xl border bg-card text-card-foreground shadow-md p-5">
                <p class="text-sm font-medium text-muted-foreground mb-1">{% trans "Low Stock" %}</p>
                <p class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ low_stock_count }}</p>
            </div>
            <div class="rounded-xl border bg-card text-card-foreground shadow-md p-5">
                <p class="text-sm font-medium text-muted-foreground mb-1">{% trans "Out of Stock" %}</p>
                <p class="text-2xl font-bold text-red-600 dark:text-red-400">{{ out_of_stock_count }}</p>
            </div>
        </div>

        <!-- Products Table -->
        <div class="rounded-xl border bg-card text-card-foreground shadow-md hover:shadow-lg transition-shadow overflow-hidden">
            <div class="p-6 border-b border-border flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold">{% trans "Product Records" %}</h3>
                    {% if showing_limited %}
                    <p class="text-sm text-muted-foreground mt-1">
                        {% blocktrans with limit=current_limit total=total_products %}Showing {{ limit }} of {{ total }} records{% endblocktrans %}
                    </p>
                    {% else %}
                    <p class="text-sm text-muted-foreground mt-1">
                        {% blocktrans with total=total_products %}Showing all {{ total }} records{% endblocktrans %}
                    </p>
                    {% endif %}
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm text-muted-foreground">{% trans "Show" %}:</label>
                    <select id="limitSelect" onchange="changeLimit(this.value)"
                        class="px-3 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                        data-current-limit="{{ current_limit }}">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                        <option value="all">{% trans "All" %}</option>
                    </select>
                    <script>
                        (function() {
                            var select = document.getElementById('limitSelect');
                            var currentLimit = select.getAttribute('data-current-limit');
                            if (currentLimit) {
                                select.value = currentLimit;
                            }
                        })();
                        function changeLimit(limit) {
                            const url = new URL(window.location.href);
                            url.searchParams.set('limit', limit);
                            window.location.href = url.toString();
                        }
                    </script>
                </div>
            </div>
            {% if products %}
            <div class="overflow-auto max-h-[600px]">
                <table class="w-full">
                    <thead class="bg-muted/50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">{% trans "SKU" %}</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">{% trans "Product" %}</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">{% trans "Category" %}</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">{% trans "Current Stock" %}</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">{% trans "Min Level" %}</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">{% trans "Purchase Price" %}</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">{% trans "Selling Price" %}</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">{% trans "Status" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr class="border-t border-border hover:bg-muted/50 transition-colors">
                            <td class="px-4 py-3 text-sm font-medium">{{ product.sku }}</td>
                            <td class="px-4 py-3 text-sm">{{ product.name }}</td>
                            <td class="px-4 py-3 text-sm">{{ product.category.name|default:"-" }}</td>
                            <td class="px-4 py-3 text-sm font-semibold">{{ product.total_stock|default:"0" }}</td>
                            <td class="px-4 py-3 text-sm">{{ product.min_stock_level }}</td>
                            <td class="px-4 py-3 text-sm">${{ product.purchase_price }}</td>
                            <td class="px-4 py-3 text-sm">${{ product.selling_price }}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                {% with stock=product.total_stock|default:0 %}
                                {% if stock == 0 %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">
                                    {% trans "Out of Stock" %}
                                </span>
                                {% elif stock <= product.min_stock_level %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400">
                                    {% trans "Low Stock" %}
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
                                    {% trans "In Stock" %}
                                </span>
                                {% endif %}
                                {% endwith %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-8 text-center">
                <p class="text-muted-foreground text-sm">{% trans "No product records found." %}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
